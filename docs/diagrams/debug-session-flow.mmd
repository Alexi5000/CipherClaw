%%{init: {'theme': 'dark', 'themeVariables': {'primaryColor': '#7c3aed', 'actorBkg': '#7c3aed', 'actorBorder': '#00ff41', 'actorTextColor': '#fff', 'signalColor': '#00ff41', 'signalTextColor': '#e0e0e0', 'noteBkgColor': '#1e1b4b', 'noteTextColor': '#c4b5fd', 'noteBorderColor': '#7c3aed', 'activationBkgColor': '#2d1b69', 'activationBorderColor': '#00ff41'}}}%%

sequenceDiagram
    participant U as ðŸ§‘â€ðŸ’» User / Veronica
    participant P as ðŸ‘» Phantom
    participant TA as ðŸ” Trace Analyst
    participant EC as âš¡ Error Classifier
    participant CP as ðŸ§  Cognitive Profiler
    participant FT as ðŸ§ª Flow Tester

    Note over U,FT: Phase 1 â€” Session Initialization
    U->>P: startSession({ domain: 'agent' })
    P-->>U: DebugSession { id, status: 'active' }

    Note over U,FT: Phase 2 â€” Trace Ingestion & Analysis
    U->>P: ingestTrace(trace)
    P->>TA: analyzeSpans(spans)
    TA->>TA: Build Causal Graph
    TA->>TA: Detect Anomalies
    TA->>TA: Detect Cascades

    alt Error Detected
        TA->>EC: Classify Error
        EC->>EC: Pattern Match + Root Cause
        EC-->>P: ClassifiedError
    end

    alt Breakpoint Hit
        P->>P: Capture State Snapshot
        P-->>U: Breakpoint Triggered
    end

    alt Anomaly Detected
        TA-->>P: Anomaly Alert
        P->>P: Run Predictive Failure Engine
        P-->>U: Prediction Warning
    end

    Note over U,FT: Phase 3 â€” Deep Analysis
    U->>P: computeCognitiveFingerprint(agentId)
    P->>CP: Profile Agent Behavior
    CP-->>P: CognitiveFingerprint { 8 dimensions }
    P->>CP: analyzeSoulIntegrity(agentId, soul)
    CP-->>P: SoulIntegrityReport
    P->>CP: analyzeMemoryHealth(memoryState)
    CP-->>P: MemoryHealthReport

    Note over U,FT: Phase 4 â€” Flow Testing
    U->>P: runFlowTests('agent')
    P->>FT: Execute Flow Tests
    FT->>FT: Validate Steps
    FT-->>P: FlowTestReport { passed, failed, coverage }

    Note over U,FT: Phase 5 â€” Report Generation
    U->>P: generateReport()
    P->>P: Aggregate All Findings
    P->>P: Compute Health Score
    P->>P: Cross-Domain Correlation
    P-->>U: VeronicaDebugReport { healthScore, recommendations }

    Note over U,FT: Phase 6 â€” Session Complete
    U->>P: completeSession()
    P-->>U: Session finalized with full audit trail
